---
title: 'üéüÔ∏è Cohort Analysis for Retail Businesses'
subtitle: ''
abstract: 'By dividing customers into groups based on the time of their first purchase, businesses can compare the performance of different cohorts and identify trends and patterns that may not be visible when analyzing all customers as a single group.'
author: 'Antonio Buzzelli'
date: "2023-05-30"
code-fold: true
draft: true
fig-width: 10
# fig-height: 10
fig-dpi: 300
image: "../../_freeze/posts/motogp-performance/performance/figure-html/cell-16-output-1.png"
categories: [Online Retail, Cohort Analysis, R]
df-print: paged
---



# Key findings and achievements

* 
* 
---

```{r}
#| output: false
library(tidyverse)
library(arrow)
```

# Data

Our dataset is composed by two-year sales data from an online store based in the UK. We first import the data and provide a glimpse of the dataframe.

```{r}
df <- arrow::read_parquet("../../data/concatenated_online_retail_II.parquet")
df <- janitor::clean_names(df)
head(df)
```
```{r}
glimpse(df)
```

# Retention

Implementing a cohort analysis is useful for a business to evaluate clients' retention over time.

```{r}
#| output: false
# Create a column with the date in which the customer was first acquired
df <- df %>%
  group_by(customer_id) %>%
  mutate(customer_since = min(invoice_date))

# Create a "lifespan" column
df$lifespan_m <- as.integer(
  as.numeric(
    difftime(df$invoice_date, df$customer_since, units = 'days')
    ) / 30.44
  )

df$cohort <- format(df$customer_since, "%Y-%m")

grouped <- df %>% 
  group_by(cohort, lifespan_m) %>% 
  summarize(n = n())
```

```{r}
grouped
```

```{r}
cohorts_abs <- pivot_wider(grouped, id_cols = 'cohort', names_from = 'lifespan_m', values_from = 'n')
```

```{r}
cohorts_perc <- data.frame(lapply(cohorts_abs[,-1], function(x) x / cohorts_abs$'0' * 100))
cohorts_perc <- cbind(cohorts_abs[1], cohorts_perc)
cohorts_perc
```

```{r}
cohorts_perc_long <- pivot_longer(cohorts_perc, cols = names(cohorts_perc[-1]), names_to = 'lifespan', values_to = 'retention_rate')

ggplot(cohorts_perc_long, aes(fct(lifespan), fct_rev(cohort)) ) +
  geom_tile(aes(fill = retention_rate)) +
  scale_fill_gradient() +
  labs(title = "Cohort Analysis - Retention", x = "Lifespan", y = "Cohort") +
  theme(aspect.ratio = 0.5)
```


